_format_version: "3.0"
_transform: true

# ===========================================
# SERVICES
# ===========================================
services:
  # Backend API Service
  - name: backend-api
    url: http://backend:3000
    routes:
      - name: api-v1-route
        paths:
          - /api/v1
        strip_path: false
      - name: api-v2-route
        paths:
          - /api/v2
        strip_path: false
      - name: health-route
        paths:
          - /health
        strip_path: false

  # WebSocket Service (for real-time updates)
  - name: websocket-service
    url: http://backend:3000
    routes:
      - name: websocket-route
        paths:
          - /ws
        strip_path: false
        protocols:
          - http
          - https
          - ws
          - wss

# ===========================================
# PLUGINS (Global)
# ===========================================
plugins:
  # Rate Limiting
  - name: rate-limiting
    config:
      minute: 100
      hour: 1000
      policy: local
      fault_tolerant: true
      hide_client_headers: false

  # Request Size Limiting (10MB for voice files)
  - name: request-size-limiting
    config:
      allowed_payload_size: 10
      size_unit: megabytes

  # CORS
  - name: cors
    config:
      origins:
        - "*"
      methods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
      headers:
        - Accept
        - Authorization
        - Content-Type
        - X-Request-ID
      exposed_headers:
        - X-Request-ID
        - X-RateLimit-Remaining
      credentials: true
      max_age: 3600

  # Request/Response Logging
  - name: file-log
    config:
      path: /dev/stdout
      reopen: true

  # Request ID (for tracing)
  - name: correlation-id
    config:
      header_name: X-Request-ID
      generator: uuid
      echo_downstream: true

# ===========================================
# CONSUMERS (for authenticated endpoints)
# ===========================================
consumers:
  - username: mobile-app
    custom_id: mobile-app-client

# ===========================================
# ROUTE-SPECIFIC PLUGINS
# ===========================================

# Higher rate limit for scan endpoints
upstreams:
  - name: backend-upstream
    targets:
      - target: backend:3000
        weight: 100
    healthchecks:
      active:
        healthy:
          interval: 10
          successes: 2
        unhealthy:
          interval: 10
          http_failures: 3
      passive:
        healthy:
          successes: 2
        unhealthy:
          http_failures: 3
