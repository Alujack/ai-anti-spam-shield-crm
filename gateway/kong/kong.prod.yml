_format_version: "3.0"
_transform: true

# ===========================================
# SERVICES
# ===========================================
services:
  # Backend API Service
  - name: backend-api
    url: http://backend:3000
    routes:
      - name: api-v1-route
        paths:
          - /api/v1
        strip_path: false
      - name: api-v2-route
        paths:
          - /api/v2
        strip_path: false
      - name: health-route
        paths:
          - /health
        strip_path: false

  # WebSocket Service
  - name: websocket-service
    url: http://backend:3000
    routes:
      - name: websocket-route
        paths:
          - /ws
        strip_path: false
        protocols:
          - http
          - https
          - ws
          - wss

# ===========================================
# PLUGINS (Global) - Production Hardened
# ===========================================
plugins:
  # Rate Limiting (stricter for production)
  - name: rate-limiting
    config:
      minute: 60
      hour: 500
      policy: local
      fault_tolerant: true
      hide_client_headers: false

  # Request Size Limiting (10MB for voice files)
  - name: request-size-limiting
    config:
      allowed_payload_size: 10
      size_unit: megabytes

  # CORS - UPDATE THESE DOMAINS!
  - name: cors
    config:
      origins:
        - https://your-domain.com
        - https://www.your-domain.com
        # Add your mobile app origin if needed
      methods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
      headers:
        - Accept
        - Authorization
        - Content-Type
        - X-Request-ID
      exposed_headers:
        - X-Request-ID
        - X-RateLimit-Remaining
      credentials: true
      max_age: 3600

  # Request ID (for tracing)
  - name: correlation-id
    config:
      header_name: X-Request-ID
      generator: uuid
      echo_downstream: true

  # Bot Detection
  - name: bot-detection
    config:
      deny:
        - curl
        - wget
      allow:
        - postman
        - insomnia

# ===========================================
# UPSTREAMS with Health Checks
# ===========================================
upstreams:
  - name: backend-upstream
    targets:
      - target: backend:3000
        weight: 100
    healthchecks:
      active:
        healthy:
          interval: 10
          successes: 2
        unhealthy:
          interval: 10
          http_failures: 3
      passive:
        healthy:
          successes: 2
        unhealthy:
          http_failures: 3
